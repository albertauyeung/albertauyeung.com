<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Sequence Labelling in NLP In natural language processing, it is a common task to extract words or phrases of particular types from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.
This is actually a special case of sequence labelling in NLP (others include POS tagging and Chunking), in which the goal is to assign a label to each member in the sequence.'>
<title>üîç Performing Sequence Labelling using CRF in Python</title>

<link rel='canonical' href='https://albertauyeung.github.io/2017/06/17/python-sequence-labelling-with-crf.html'>

<link rel="stylesheet" href="/scss/style.min.ebb0feb1238c5f4c8e14c9febf04dc409a6cacb74e106e0c4e417e5eb085669e.css"><meta property='og:title' content='üîç Performing Sequence Labelling using CRF in Python'>
<meta property='og:description' content='Sequence Labelling in NLP In natural language processing, it is a common task to extract words or phrases of particular types from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.
This is actually a special case of sequence labelling in NLP (others include POS tagging and Chunking), in which the goal is to assign a label to each member in the sequence.'>
<meta property='og:url' content='https://albertauyeung.github.io/2017/06/17/python-sequence-labelling-with-crf.html'>
<meta property='og:site_name' content='Albert Au Yeung'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='python' /><meta property='article:tag' content='machine learning' /><meta property='article:tag' content='sequence labelling' /><meta property='article:tag' content='crf' /><meta property='article:published_time' content='2017-06-17T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2017-06-17T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="üîç Performing Sequence Labelling using CRF in Python">
<meta name="twitter:description" content="Sequence Labelling in NLP In natural language processing, it is a common task to extract words or phrases of particular types from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.
This is actually a special case of sequence labelling in NLP (others include POS tagging and Chunking), in which the goal is to assign a label to each member in the sequence.">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "light");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/avatar_hu504580e4e0594bf3f7bf7b76af994632_241575_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Albert Au Yeung</a></h1>
            <h2 class="site-description">AI/ML Engineer</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/about' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#sequence-labelling-in-nlp">Sequence Labelling in NLP</a></li>
    <li><a href="#methods-of-sequence-labelling">Methods of Sequence Labelling</a></li>
    <li><a href="#conditional-random-field-crf">Conditional Random Field (CRF)</a></li>
    <li><a href="#train-crf-model-in-python">Train CRF Model in Python</a>
      <ul>
        <li><a href="#named-entity-recogniton">Named Entity Recogniton</a></li>
        <li><a href="#prepare-the-dataset-for-training">Prepare the Dataset for Training</a></li>
        <li><a href="#generating-part-of-speech-tags">Generating Part-of-Speech Tags</a></li>
        <li><a href="#generating-features">Generating Features</a></li>
        <li><a href="#training-the-model">Training the Model</a></li>
        <li><a href="#checking-the-results">Checking the Results</a></li>
        <li><a href="#source-codes">Source Codes</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/2017/06/17/python-sequence-labelling-with-crf.html">üîç Performing Sequence Labelling using CRF in Python</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 17, 2017</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    12 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="sequence-labelling-in-nlp">Sequence Labelling in NLP</h2>
<p>In <a class="link" href="https://en.wikipedia.org/wiki/Natural_language_processing"  target="_blank" rel="noopener"
    >natural language processing</a>, it is a common task to <strong>extract words or phrases of particular types</strong> from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.</p>
<p>This is actually a special case of <strong>sequence labelling</strong> in NLP (others include <a class="link" href="https://en.wikipedia.org/wiki/Part-of-speech_tagging"  target="_blank" rel="noopener"
    >POS tagging</a> and <a class="link" href="https://en.wikipedia.org/wiki/Shallow_parsing"  target="_blank" rel="noopener"
    >Chunking</a>), in which the goal is to assign a label to each member in the sequence. In the case of identifying country names, we would like to assign a &lsquo;<em>country</em>&rsquo; label to words that form part of a country name, and a &lsquo;<em>irrelevant</em>&rsquo; label to all other words. For example, the following is a sentence broken down into tokens, and its desired output after the sequence labelling process:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>input <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Paris&#34;</span>, <span style="color:#e6db74">&#34;is&#34;</span>, <span style="color:#e6db74">&#34;the&#34;</span>, <span style="color:#e6db74">&#34;capital&#34;</span>, <span style="color:#e6db74">&#34;of&#34;</span>, <span style="color:#e6db74">&#34;France&#34;</span>]
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>]
</span></span></code></pre></div><p>where <em>I</em> means that the token of that position is an irrelevant word, and <em>C</em> means that the token of that position is a word that form part of a country name.</p>
<h2 id="methods-of-sequence-labelling">Methods of Sequence Labelling</h2>
<p>A simple, though sometimes quite useful, approach is to prepare a <strong>dictionary</strong> of country names, and look for these names in each of the sentences in the corpus. However, this method relies heavily on the comprehensiveness of the dictionary. While there is a limited number of countries, in other cases such as city names the number of possible entries in the dictionary can be huge. Even for countries, many countries may be referred to using different sequence of characters in different contexts. For example, the United States of America may be referred to in an article as <em>the USA</em>, <em>the States</em>, or simply <em>America</em>.</p>
<p>In fact, a person reading a news article would usually recognise that a word or a phrase refers to a country, even when he or she has not seen the name of that country before. The reason is that there are many differnt <strong>cues</strong> in the sentence or the whole article that can be used to determine whether a word or a phrase is a country name. Take the following two sentences as examples:</p>
<ul>
<li>Kerry travels to <strong>Laos</strong>&rsquo;s capital, Vientiane, on Monday for meetings of foreign ministers from the 10-member Association of South East Asia Nations (ASEAN).</li>
<li>The Governments of <strong>Bolivia</strong> and <strong>Uruguay</strong> will strengthen ties with a customs cooperation agreement to be in force on June 15th.</li>
</ul>
<p>The first sentence implies that something called <strong>Lao</strong> has a capital, suggesting that <strong>Lao</strong> is a country. Similarly, in the second sentence we know that both <strong>Bolivia</strong> and <strong>Uruguay</strong> are countries as the news mentioned about their governments. In other words, the words around &lsquo;Lao&rsquo;, &lsquo;Bolivia&rsquo; and &lsquo;Uruguay&rsquo; provide clues as to whether they are country names.</p>
<h2 id="conditional-random-field-crf">Conditional Random Field (CRF)</h2>
<p>To take advantage of the surrounding context when labelling tokens in a sequence, a commonly used method is <a class="link" href="https://en.wikipedia.org/wiki/Conditional_random_field"  target="_blank" rel="noopener"
    >conditional random field</a> (CRF), first proposed by <a class="link" href="http://repository.upenn.edu/cgi/viewcontent.cgi?article=1162&amp;context=cis_papers"  target="_blank" rel="noopener"
    >Lafferty et al.</a> in 2001. It is  a type of probabilistic graphical model that can be used to model sequential data, such as labels of words in a sentence.</p>
<p>This article is not intended to discuss the technical details of CRF. If you are interested, you are recommended to check out one of the following tutorials which provide very good explanation of how CRF works:</p>
<ul>
<li><a class="link" href="http://homepages.inf.ed.ac.uk/csutton/publications/crftut-fnt.pdf"  target="_blank" rel="noopener"
    >An Introduction to Conditional
Random Fields</a> by Charles Sutton and Andrew McCallum</li>
<li><a class="link" href="http://blog.echen.me/2012/01/03/introduction-to-conditional-random-fields/"  target="_blank" rel="noopener"
    >Introduction to Conditional Random Fields</a> by Edwin Chen</li>
</ul>
<p>In CRF, we will design a set of <strong>feature functions</strong> to extract features for each word in a sentence. During model training, CRF will try to determine the weights of different feature functions that will maximise the likelihood of the labels in the training data.</p>
<h2 id="train-crf-model-in-python">Train CRF Model in Python</h2>
<p>One of the commonly used CRF library is <a class="link" href="http://www.chokkan.org/software/crfsuite/"  target="_blank" rel="noopener"
    >CRFSuite implemented by Naoaki Okazaki</a> in C/C++. The library is already easy to use given its command line interface. A Python binding to CRFSuite, <a class="link" href="https://github.com/scrapinghub/python-crfsuite"  target="_blank" rel="noopener"
    >pycrfsuite</a> is available for using the API in Python. This Python module is exactly the module used in the POS tagger in the <a class="link" href="http://www.nltk.org/"  target="_blank" rel="noopener"
    >nltk module</a>.</p>
<p>To demonstrate how pysrfsuite can be used to train a linear chained CRF sequence labelling model, we will go through an example using some data for <em>named entity recognition</em>.</p>
<h3 id="named-entity-recogniton">Named Entity Recogniton</h3>
<p>To train a named entity recognition model, we need some labelled data. The dataset that will be used below is the <strong>Reuters-128 dataset</strong>, which is an English corpus in the NLP Interchange Format (NIF). It contains 128 economic news articles. The dataset contains information for <strong>880</strong> named entities with their position in the document and a URI of a <a class="link" href="http://wiki.dbpedia.org/"  target="_blank" rel="noopener"
    >DBpedia</a> resource identifying the entity. It was created by the <a class="link" href="http://aksw.org/About.html"  target="_blank" rel="noopener"
    >Agile Knowledge Engineering and Semantic Web research group at Leipzig University, Germany</a>. More details can be found in <a class="link" href="http://svn.aksw.org/papers/2014/LREC_N3NIFNERNED/public.pdf"  target="_blank" rel="noopener"
    >their paper</a>.</p>
<p>In the following, we will use the XML verison of the dataset, which can be downloaded from <a class="link" href="https://github.com/AKSW/n3-collection"  target="_blank" rel="noopener"
    >https://github.com/AKSW/n3-collection</a>. Below is some lines extracted from the XML data file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">document</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">documenturi</span>&gt;http://www.research.att.com/~lewis/Reuters-21578/15009&lt;/<span style="color:#f92672">documenturi</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">documentsource</span>&gt;Reuters-21578&lt;/<span style="color:#f92672">documentsource</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">textwithnamedentities</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">namedentityintext</span> <span style="color:#a6e22e">uri</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://aksw.org/notInWiki/Home_Intensive_Care_Inc&#34;</span>&gt;Home Intensive Care Inc&lt;/<span style="color:#f92672">namedentityintext</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">simpletextpart</span>&gt; said it has opened a Dialysis at Home office in &lt;/<span style="color:#f92672">simpletextpart</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">namedentityintext</span> <span style="color:#a6e22e">uri</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://dbpedia.org/resource/Philadelphia&#34;</span>&gt;Philadelphia&lt;/<span style="color:#f92672">namedentityintext</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">simpletextpart</span>&gt;, its 12th nationwide.&lt;/<span style="color:#f92672">simpletextpart</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">textwithnamedentities</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">document</span>&gt;
</span></span></code></pre></div><p>The XML block shown above refers to one of the documents in the dataset. The semantics is self-explanatory. The document has a sentence &lsquo;Home Intensive Care Inc said it has opened a Dialysis at Home office in Philadelphia, its 12th nationwide&rsquo;, in which <strong>Home Intensive Care Inc</strong> and <strong>Philadelphia</strong> are labelled as named entities.</p>
<h3 id="prepare-the-dataset-for-training">Prepare the Dataset for Training</h3>
<p>In order to prepare the dataset for training, we need to label every word (or token) in the sentences to be either <em>irrelevant</em> or part of a <em>named entity</em>. Since the data is in XML format, we can make use of <a class="link" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/"  target="_blank" rel="noopener"
    >BeautifulSoup</a> to parse the file and extract the data as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup <span style="color:#66d9ef">as</span> bs
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4.element <span style="color:#f92672">import</span> Tag
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> codecs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read data file and parse the XML</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> codecs<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;reuters.xml&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>, <span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> infile:
</span></span><span style="display:flex;"><span>    soup <span style="color:#f92672">=</span> bs(infile, <span style="color:#e6db74">&#34;html5lib&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docs <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> elem <span style="color:#f92672">in</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;document&#34;</span>):
</span></span><span style="display:flex;"><span>    texts <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Loop through each child of the element under &#34;textwithnamedentities&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> elem<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;textwithnamedentities&#34;</span>)<span style="color:#f92672">.</span>children:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> type(c) <span style="color:#f92672">==</span> Tag:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> c<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;namedentityintext&#34;</span>:
</span></span><span style="display:flex;"><span>                label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;N&#34;</span>  <span style="color:#75715e"># part of a named entity</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;I&#34;</span>  <span style="color:#75715e"># irrelevant word</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> c<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(w) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                    texts<span style="color:#f92672">.</span>append((w, label))
</span></span><span style="display:flex;"><span>    docs<span style="color:#f92672">.</span>append(texts)
</span></span></code></pre></div><p>The result will be a list of documents, each of which contains a list of (word, label) tuples. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> doc[<span style="color:#ae81ff">0</span>][:<span style="color:#ae81ff">10</span>]
</span></span><span style="display:flex;"><span>[(<span style="color:#e6db74">&#39;Paxar&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;Corp&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;said&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;it&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;has&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;acquired&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;Thermo-Print&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span></code></pre></div><h3 id="generating-part-of-speech-tags">Generating Part-of-Speech Tags</h3>
<p>To train a CRF model, we need to create features for each of the tokens in the sentences. One particularly useful feature in NLP is the <a class="link" href="https://en.wikipedia.org/wiki/Part-of-speech_tagging"  target="_blank" rel="noopener"
    >part-of-speech (POS) tags</a> of the words. They indicates whether a word is a noun, a verb or an adjective. (In fact, a POS tagger is also usually a trained CRF model.)</p>
<p>We can use <a class="link" href="http://www.nltk.org/book/ch05.html"  target="_blank" rel="noopener"
    >NLTK&rsquo;s POS tagger</a> to generate the POS tags for the tokens in our documents as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> nltk
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, doc <span style="color:#f92672">in</span> enumerate(docs):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Obtain the list of tokens in the document</span>
</span></span><span style="display:flex;"><span>    tokens <span style="color:#f92672">=</span> [t <span style="color:#66d9ef">for</span> t, label <span style="color:#f92672">in</span> doc]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform POS tagging</span>
</span></span><span style="display:flex;"><span>    tagged <span style="color:#f92672">=</span> nltk<span style="color:#f92672">.</span>pos_tag(tokens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Take the word, POS tag, and its label</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span>append([(w, pos, label) <span style="color:#66d9ef">for</span> (w, label), (word, pos) <span style="color:#f92672">in</span> zip(doc, tagged)])
</span></span></code></pre></div><p>The output of the above process will be a list of documents, each of which is a list of tuples with the word, its POS tag and its label:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> data[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>[(<span style="color:#e6db74">&#39;Paxar&#39;</span>, <span style="color:#e6db74">&#39;NNP&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;Corp&#39;</span>, <span style="color:#e6db74">&#39;NNP&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;said&#39;</span>, <span style="color:#e6db74">&#39;VBD&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;it&#39;</span>, <span style="color:#e6db74">&#39;PRP&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;has&#39;</span>, <span style="color:#e6db74">&#39;VBZ&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;acquired&#39;</span>, <span style="color:#e6db74">&#39;VBN&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#e6db74">&#39;Thermo-Print&#39;</span>, <span style="color:#e6db74">&#39;NNP&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> <span style="color:#f92672">...</span>
</span></span></code></pre></div><h3 id="generating-features">Generating Features</h3>
<p>Given the POS tags, we can now continue to generate more features for each of the tokens in the dataset. The features that will be useful in the training process depends on the task at hand. Below are some of the commonly used features for a word $w$ in named entity recognition:</p>
<ul>
<li>The word $w$ itself (converted to lowercase for normalisation)</li>
<li>The prefix/suffix of $w$ (e.g. -ion)</li>
<li>The words surrounding $w$, such as the previous and the next word</li>
<li>Whether $w$ is in uppercase or lowercase</li>
<li>Whether $w$ is a number, or contains digits</li>
<li>The POS tag of $w$, and those of the surrounding words</li>
<li>Whether $w$ is or contains a special character (e.g. hypen, dollar sign)</li>
</ul>
<p>Below is a function for generating features for our documents. It takes a doc (in the form of a listof tuples as shown above), and an index (the $i$th document), and return the documents with features extracted. (A similar example can be found in <a class="link" href="https://github.com/scrapinghub/python-crfsuite/blob/master/examples/CoNLL%202002.ipynb"  target="_blank" rel="noopener"
    >the repository of pyscrfsuite</a>.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">word2features</span>(doc, i):
</span></span><span style="display:flex;"><span>    word <span style="color:#f92672">=</span> doc[i][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    postag <span style="color:#f92672">=</span> doc[i][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Common features for all words</span>
</span></span><span style="display:flex;"><span>    features <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;bias&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word.lower=&#39;</span> <span style="color:#f92672">+</span> word<span style="color:#f92672">.</span>lower(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word[-3:]=&#39;</span> <span style="color:#f92672">+</span> word[<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>:],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word[-2:]=&#39;</span> <span style="color:#f92672">+</span> word[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word.isupper=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word<span style="color:#f92672">.</span>isupper(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word.istitle=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word<span style="color:#f92672">.</span>istitle(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;word.isdigit=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word<span style="color:#f92672">.</span>isdigit(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;postag=&#39;</span> <span style="color:#f92672">+</span> postag
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Features for words that are not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># at the beginning of a document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        word1 <span style="color:#f92672">=</span> doc[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        postag1 <span style="color:#f92672">=</span> doc[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        features<span style="color:#f92672">.</span>extend([
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;-1:word.lower=&#39;</span> <span style="color:#f92672">+</span> word1<span style="color:#f92672">.</span>lower(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;-1:word.istitle=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>istitle(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;-1:word.isupper=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>isupper(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;-1:word.isdigit=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>isdigit(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;-1:postag=&#39;</span> <span style="color:#f92672">+</span> postag1
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Indicate that it is the &#39;beginning of a document&#39;</span>
</span></span><span style="display:flex;"><span>        features<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;BOS&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Features for words that are not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># at the end of a document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(doc)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        word1 <span style="color:#f92672">=</span> doc[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        postag1 <span style="color:#f92672">=</span> doc[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        features<span style="color:#f92672">.</span>extend([
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;+1:word.lower=&#39;</span> <span style="color:#f92672">+</span> word1<span style="color:#f92672">.</span>lower(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;+1:word.istitle=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>istitle(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;+1:word.isupper=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>isupper(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;+1:word.isdigit=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> word1<span style="color:#f92672">.</span>isdigit(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;+1:postag=&#39;</span> <span style="color:#f92672">+</span> postag1
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Indicate that it is the &#39;end of a document&#39;</span>
</span></span><span style="display:flex;"><span>        features<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;EOS&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> features
</span></span></code></pre></div><h3 id="training-the-model">Training the Model</h3>
<p>To train the model, we need to first prepare the training data and the corresponding labels. Also, to be able to investigate the accuracy of the model, we need to separate the data into training set and test set. Below are some codes for preparing the training data and test data, using the <a class="link" href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html"  target="_blank" rel="noopener"
    ><code>train_test_split</code> function in scikit-learn</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A function for extracting features in documents</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_features</span>(doc):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [word2features(doc, i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(doc))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A function fo generating the list of labels for each document</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_labels</span>(doc):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [label <span style="color:#66d9ef">for</span> (token, postag, label) <span style="color:#f92672">in</span> doc]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> [extract_features(doc) <span style="color:#66d9ef">for</span> doc <span style="color:#f92672">in</span> data]
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> [get_labels(doc) <span style="color:#66d9ef">for</span> doc <span style="color:#f92672">in</span> data]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X_train, X_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(X, y, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
</span></span></code></pre></div><p>In <code>pycrfsuite</code>, A CRF model in can be trained by first creating a <strong>trainer</strong>, and then submit the training data and corresponding labels to the trainer. After that, set the parameters and call <code>train()</code> to start the training process. For the complete list of parameters, one can refer to the <a class="link" href="http://www.chokkan.org/software/crfsuite/manual.html#idp8849114176"  target="_blank" rel="noopener"
    >documentation of CRFSuite</a>. With the very small dataset in this example, the training with <code>max_iterations=200</code> can be finished in a few seconds. Below is the code for creating the trainer and start training the model:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pycrfsuite
</span></span><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> pycrfsuite<span style="color:#f92672">.</span>Trainer(verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Submit training data to the trainer</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> xseq, yseq <span style="color:#f92672">in</span> zip(X_train, y_train):
</span></span><span style="display:flex;"><span>    trainer<span style="color:#f92672">.</span>append(xseq, yseq)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the parameters of the model</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#f92672">.</span>set_params({
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># coefficient for L1 penalty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;c1&#39;</span>: <span style="color:#ae81ff">0.1</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># coefficient for L2 penalty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;c2&#39;</span>: <span style="color:#ae81ff">0.01</span>,  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># maximum number of iterations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;max_iterations&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># whether to include transitions that</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># are possible, but not observed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;feature.possible_transitions&#39;</span>: <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Provide a file name as a parameter to the train function, such that</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the model will be saved to the file when training is finished</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#f92672">.</span>train(<span style="color:#e6db74">&#39;crf.model&#39;</span>)
</span></span></code></pre></div><p>If you have set <code>verbose=True</code> when initialising the trainer, the trainer will print out the training progress as it is trained against the provided training data.</p>
<h3 id="checking-the-results">Checking the Results</h3>
<p>Once we have the model trained, we can apply it on our test data and see whether it gives reasonable results. Assuming that the model is saved to a file named <code>crf.model</code>. The following block of code shows how we can load the model into memory, and apply it on to our test data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tagger <span style="color:#f92672">=</span> pycrfsuite<span style="color:#f92672">.</span>Tagger()
</span></span><span style="display:flex;"><span>tagger<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;crf.model&#39;</span>)
</span></span><span style="display:flex;"><span>y_pred <span style="color:#f92672">=</span> [tagger<span style="color:#f92672">.</span>tag(xseq) <span style="color:#66d9ef">for</span> xseq <span style="color:#f92672">in</span> X_test]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Let&#39;s take a look at a random sample in the testing set</span>
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(y_pred[i], [x[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> X_test[i]]):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (y, x))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">The following will be printed:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sci-med (N)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">life (N)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systems (N)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">inc (N)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">said (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">its (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">directors (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">approved (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">a (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">previously (I)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>The result looks reasonable as the first four words are correctly identified as part of a named entity.</p>
<p>To study the performance of the CRF tagger trained above in a more quantitative way, we can check the <strong>precision</strong> and <strong>recall</strong> on the test data. This can be done very easily using the <a class="link" href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html"  target="_blank" rel="noopener"
    ><code>classification_report</code> function in scikit-learn</a>. However, given that the predictions are sequences of tags, we need to transform the data into a list of labels before feeding them into the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> classification_report
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a mapping of labels to indices</span>
</span></span><span style="display:flex;"><span>labels <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;N&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;I&#34;</span>: <span style="color:#ae81ff">0</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert the sequences of tags into a 1-dimensional array</span>
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([labels[tag] <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> y_pred <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> row])
</span></span><span style="display:flex;"><span>truths <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([labels[tag] <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> y_test <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> row])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print out the classification report</span>
</span></span><span style="display:flex;"><span>print(classification_report(
</span></span><span style="display:flex;"><span>    truths, predictions,
</span></span><span style="display:flex;"><span>    target_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;I&#34;</span>, <span style="color:#e6db74">&#34;N&#34;</span>]))
</span></span></code></pre></div><p>which will prints a report as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>              precision   recall  f1<span style="color:#f92672">-</span>score   support
</span></span><span style="display:flex;"><span>          I       <span style="color:#ae81ff">0.98</span>      <span style="color:#ae81ff">0.98</span>      <span style="color:#ae81ff">0.98</span>      <span style="color:#ae81ff">3322</span>
</span></span><span style="display:flex;"><span>          N       <span style="color:#ae81ff">0.85</span>      <span style="color:#ae81ff">0.85</span>      <span style="color:#ae81ff">0.85</span>       <span style="color:#ae81ff">405</span>
</span></span><span style="display:flex;"><span>avg <span style="color:#f92672">/</span> total       <span style="color:#ae81ff">0.97</span>      <span style="color:#ae81ff">0.97</span>      <span style="color:#ae81ff">0.97</span>      <span style="color:#ae81ff">3727</span>
</span></span></code></pre></div><p>We can see that we have achieved 85% precision and 85% recall in predicting whether a word is part of a named entity. There are several things by which we can improve the performance, including creating better features or tuning the parameters of the CRF model.</p>
<h3 id="source-codes">Source Codes</h3>
<p>The source code for reproducing the above results can be found in the following github repository: <a class="link" href="https://github.com/albertauyeung/python-crf-named-entity-recognition"  target="_blank" rel="noopener"
    >https://github.com/albertauyeung/python-crf-named-entity-recognition</a>.</p>
<h2 id="references">References</h2>
<ul>
<li>Lafferty, J., McCallum, A., Pereira, F. (2001). <a class="link" href="http://repository.upenn.edu/cgi/viewcontent.cgi?article=1162&amp;context=cis_papers"  target="_blank" rel="noopener"
    >&ldquo;Conditional random fields: Probabilistic models for segmenting and labeling sequence data&rdquo;</a>. Proc. 18th International Conf. on Machine Learning. Morgan Kaufmann. pp. 282‚Äì289.</li>
<li>Erdogan, H. (2010). <a class="link" href="http://www.icmla-conference.org/icmla10/CFP_Tutorial_files/hakan.pdf"  target="_blank" rel="noopener"
    >Sequence Labeling: Generative and Discriminative Approaches - Hidden Markov Models, Conditional Random Fields and Structured SVMs</a>. ICMLA 2010 Tutorial.</li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/python/">python</a>
        
            <a href="/tags/machine-learning/">machine learning</a>
        
            <a href="/tags/sequence-labelling/">sequence labelling</a>
        
            <a href="/tags/crf/">crf</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/2017/04/23/python-matrix-factorization.html">
        
        

        <div class="article-details">
            <h2 class="article-title">üî• Matrix Factorization: A Simple Tutorial and Implementation in Python</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 Albert Au Yeung
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
